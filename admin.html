<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lecturer Dashboard | QR Attendance System</title>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --unikl-blue:#0b1f6a;
      --unikl-orange:#f58220;
      --success:#28a745;
      --danger:#dc3545;
      --muted:#6b7280;
      --bg:#f4f6f8;
      --card:#ffffff;
      --radius:14px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#1f2937;
    }

    /* ===== UniKL TOP STRIPE HEADER ===== */
    .top-stripe{
      height:56px;
      display:flex;
      align-items:center;
      background:white;
      box-shadow:0 2px 6px rgba(3,6,12,0.06);
      position:sticky;
      top:0;
      z-index:50;
    }

    .stripe-orange{
      flex:0 0 8%;
      background:#f58220;
      height:100%;
    }

    .stripe-blue{
      flex:0 0 18%;
      background:#011e6a;
      height:100%;
    }

    .stripe-white{
      flex:1;
      height:100%;
      background:white;
      display:flex;
      align-items:center;
      padding-left:18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:600;
  color:#213247;
}

.brand img{
  height:38px;
}

/* Mobile: hide text */
@media(max-width:980px){
  .brand{ display:none !important; }
  .top-stripe{ height:42px !important; }
  .stripe-white{ padding-left:0 !important; }
}

    /* White content area */
    .header-main {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 32px;
      font-size: 15px;
      font-weight: 600;
      color: #0b1f6a;
      background: #ffffff;
    }

    .header-main img {
      height: 40px;
    }

    /* ===== Dashboard Card ===== */
    .container{
      max-width:1100px;
      margin: 40px auto;
      padding:0 12px;
    }

    .app{
      background:var(--card);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 20px 40px rgba(15,23,42,.12);
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
    }

    h1{
      margin:0;
      font-size:1.6rem;
      color:var(--unikl-blue);
    }

    .subtitle{
      font-size:.95rem;
      color:#6b7280;
      margin-top:4px;
    }

    .top-right{
      text-align:right;
      font-size:.9rem;
      color:#555;
    }

    /* ===== Controls ===== */
    .controls{
      margin-top:16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    select,input,button{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      font-weight:600;
      cursor:pointer;
    }

    select,input{
      background:#f9fafb;
    }

    .btn-blue{ background: #011e6a;color: #ffffff;border: none;border-radius: 10px;font-weight: 600 }
    .btn-green{ background:var(--success); color:#fff; border:none; }
    .btn-red{ background:var(--danger); color:#fff; border:none; }
    .btn-gray{ background:#9ca3af; color:#fff; border:none; }

    .actions{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }

    /* ===== Table ===== */
    .card{
      margin-top:18px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #e5e7eb;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }

    th{
      background: var(--unikl-blue); 
      color: #ffffff;
      text-align: left;
      padding: 12px;
      font-weight: 600;
    }

    td{
      padding:12px;
      border-bottom:1px solid #f1f5f9;
    }

    .status-present{ color:var(--success); font-weight:700 }
    .status-absent{ color:var(--danger); font-weight:700 }
    .status-pending{ color:var(--unikl-orange); font-weight:700 }

    /* ===== Scanner Overlay ===== */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      display:none;
      z-index:999;
      justify-content:center;
      align-items:center;
    }

    .scanner-card{
      background:#000;
      border-radius:14px;
      overflow:hidden;
      width:100%;
      max-width:640px;
    }

    .avatar{
      width:72px;
      height:72px;
      border-radius:12px;
      object-fit: contain;      
      background:#f1f5f9;       
      border:1px solid #e5e7eb;
    }


    video{
      width:100%;
      height:420px;
      object-fit:cover;
    }

    .scanner-footer{
      background:#fff;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    /* ===== Status Pills ===== */
    .status-pill {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      line-height: 1;
    }

    .status-present {
      background: #e6f6ea;
      color: #1e7e34;
    }

    .status-absent {
      background: #fde8e8;
      color: #c81e1e;
    }

    .status-pending {
      background: #fff4e5;
      color: #b45309;
    }

    /* ===== Action Buttons ===== */
    .actions-cell {
      display: flex;
      gap: 8px;
    }

    .btn-view {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 8px;
      border: none;
      background: #9ca3af;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-verify {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 8px;
      border: none;
      background: #1e3a8a;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-verify:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .btn-view:hover {
      background: #6b7280;
    }

    .btn-verify:hover {
      background: #1e40af;
    }

    /* ===== Modal ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal-card {
      background: #ffffff;
      width: 420px;
      border-radius: 16px;
      box-shadow: 0 25px 50px rgba(0,0,0,.25);
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #0b1f6a;
    }

    .modal-close {
      font-size: 22px;
      border: none;
      background: none;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
      display: flex;
      gap: 16px;
    }

    .modal-info {
      flex: 1;
      min-width: 0;
      padding-top: 4px;
    }

    .modal-photo {
      width: 110px;
      height: 140px;             
      border-radius: 14px;
      object-fit: contain;        
      background: #f1f5f9;
      border: 1px solid #e5e7eb;
      flex-shrink: 0;             
    }

    .modal-info p {
      margin: 6px 0;
      font-size: 14px;
      line-height: 1.4;
    }

    /* ===== PHOTO CENTERED ===== */
    td[data-label="Photo"] {
      justify-content: center;
    }

    td[data-label="Photo"] img.avatar {
      width: 72px;
      height: 72px;
      border-radius: 50%;
    }

    /* ===== STATUS CENTER ===== */
    td[data-label="Status"] {
      justify-content: center;
    }

    /* ===== ACTIONS FIX ===== */
    td[data-label="Actions"] {
      flex-direction: column;
      gap: 10px;
    }

    td[data-label="Actions"] button {
      width: 100%;
      text-align: center;
    }

    /* ===== LABELS ===== */
    td::before {
      content: attr(data-label);
      font-weight: 600;
      color: #6b7280;
      font-size: 14px;
      flex: 0 0 48px; /* keeps Name & ID closer */
    }

    /* ===== PHOTO FIX ===== */
    td.photo-cell::before {
      display: none; /* remove "Photo" text */
    }

    td.photo-cell {
      justify-content: center;
      padding-bottom: 12px;
    }

    td.photo-cell img.avatar {
      width: 88px;
      height: 88px;
      object-fit: cover;
      border-radius: 10px; 
      border: 2px solid #e5e7eb;
    }

    /* ===== STATUS CENTER ===== */
    td[data-label="Status"] {
      justify-content: center;
    }

    /* ===== ACTIONS ===== */
    td[data-label="Actions"] {
      flex-direction: column;
      gap: 10px;
      padding-top: 12px;
    }

    td[data-label="Actions"] button {
      width: 100%;
      text-align: center;
    }

    /* === FORCE MODAL TEXT VISIBILITY === */
    .modal-info span {
      color: #111827 !important;   /* dark text */
      font-weight: 500;
    }

    .modal-info strong {
      color: #374151;              /* label color */
      font-weight: 600;
    }

    @media(max-width:900px){
      .actions{ grid-template-columns:repeat(2,1fr); }
    }

    /* =====================================================
   ‚úÖ FINAL MOBILE STUDENT CARD LAYOUT (CLEAN & TIGHT)
   ===================================================== */
    @media (max-width: 768px) {

      table,
      thead,
      tbody,
      tr,
      td {
        display: block;
        width: 100%;
      }

      thead {
        display: none;
      }

      tbody tr {
        background: #ffffff;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 18px;
        box-shadow: 0 8px 22px rgba(0,0,0,0.08);
      }

      /* ===== ROWS ===== */
      tbody td {
        display: grid;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        border: none;
      }

      /* ===== LABEL ===== */
      tbody td::before {
        content: attr(data-label);
        min-width: 60px;
        font-weight: 600;
        color: #6b7280;
        font-size: 14px;
        text-align: left;
      }

      /* ===== PHOTO ===== */
      td.photo-cell {
        display: flex;
        justify-content: center;
        padding-bottom: 10px;
      }


      td.photo-cell::before {
        display: none; /* remove "Photo" text */
      }

      td.photo-cell img.avatar {
        width: 90px;
        height: 90px;
        border-radius: 10px; /* square passport style */
        object-fit: cover;
        border: 2px solid #e5e7eb;
      }

  /* ===== STATUS ===== */
  td[data-label="Status"] {
    display: flex;
    align-items: center;
    gap: 12px;
  }


  td[data-label="Status"] .status-pill {
    margin-left: 0;
  }

  /* ===== ACTIONS ===== */
  td[data-label="Actions"] {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-top: 12px;
  }

  td[data-label="Actions"] button {
    width: 100%;
    text-align: center;
  }
}

/* =========================
   DESKTOP: hide mobile labels
   ========================= */
  @media (min-width: 769px) {
    td::before {
      display: none !important;
      content: none !important;
    }
  }

 </style>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<body>

  <!-- TOP HEADER BAR -->
  <div class="top-stripe">
    <div class="stripe-orange"></div>
    <div class="stripe-blue"></div>
    <div class="stripe-white">
      <div class="brand">
        <img src="assets/unikl-wordmark.webp">
        QR Attendance System ‚Äî Universiti Kuala Lumpur
      </div>
    </div>
  </div>

  <!-- ===== Dashboard ===== -->
  <div class="container">
    <div class="app">

      <div class="header">
        <div>
          <h1>Lecturer Dashboard</h1>
          <div class="subtitle">QR-Based Student Attendance ‚Äî Face verification flow</div>
        </div>

        <div class="top-right">
          <div id="loggedAs">Checking auth‚Ä¶</div>
          <button id="manageStudentsBtn" class="btn-gray" style="margin-top:8px">
            Manage Students
          </button>
        </div>
      </div>

      <!-- ===== View Student Modal ===== -->
      <div id="viewStudentModal" class="modal-overlay hidden">
        <div class="modal-card">
          <div class="modal-header">
            <h3>Student Details</h3>
            <button id="closeViewModal" class="modal-close">&times;</button>
          </div>

          <div class="modal-body">
            <img id="modalStudentPhoto" class="modal-photo" src="" alt="Student Photo">

            <div class="modal-info">
              <p><strong>Name:</strong> <span id="modalStudentName">-</span></p>
              <p><strong>Student ID:</strong> <span id="modalStudentId">-</span></p>
              <p><strong>Email:</strong> <span id="modalStudentEmail">-</span></p>
              <p><strong>Status:</strong> <span id="modalStudentStatus">-</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== Controls ===== -->
      <div class="controls">
        <select id="sessionSelect">
          <option disabled selected>Select Session</option>
        </select>

        <input
          id="sessionNameInput"
          placeholder="New session name (e.g. Quiz 1)"
        />
        <button id="createSessionBtn" class="btn-blue">+ New Session</button>
        <button id="startScannerBtn" class="btn-blue">üì∑ Start QR Scanner</button>
      </div>

      <div class="actions">
        <button id="exportCurrentBtn" class="btn-green">üìÑ Export Current Session</button>
        <button id="resetSessionBtn" class="btn-gray">üîÅ Reset Current Session</button>
        <button id="logoutBtn" class="btn-red">üö™ Logout</button>
      </div>

      <!-- ===== Students Table ===== -->
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>ID</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentsBody">
            <tr>
              <td colspan="3" style="text-align:center;color:#6b7280;padding:24px">
                Select a session to load students
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- firebase + qr scanner libs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDocs,
      getDoc,
      addDoc,
      updateDoc,
      serverTimestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    

    /* ================= FIREBASE ================= */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ================= DOM ================= */
    const sessionSelect = document.getElementById("sessionSelect");
    const studentTable = document.querySelector("tbody");
    const startScannerBtn = document.getElementById("startScannerBtn");
    const logoutBtn = document.getElementById("logoutBtn");


    /* ================= AUTH ================= */
    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = "index.html";
        return;
      }

      const loggedAs = document.getElementById("loggedAs");
      if (loggedAs) {
        loggedAs.textContent = `Logged in as ${user.email}`;
      }
    });


    /* ================= LOAD SESSIONS ================= */
    async function loadSessions() {
      sessionSelect.innerHTML = `<option value="">Select session</option>`;

      const snap = await getDocs(collection(db, "sessions"));

      snap.forEach(docSnap => {
        const data = docSnap.data();

        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = data.name || docSnap.id;

        sessionSelect.appendChild(opt);
      });
    }

    // ===== Restore Last Selected Session =====
    async function restoreLastSession() {
      const lastSession = localStorage.getItem("activeSessionId");
      if (!lastSession) return;

      sessionSelect.value = lastSession;
      await ensureSessionAttendance(lastSession);
      await loadStudentsForSession(lastSession);
    }

loadSessions().then(restoreLastSession);


    /* ================= PREPARE SESSION ATTENDANCE (FIXED) ================= */
    async function ensureSessionAttendance(sessionId) {
      const studentsSnap = await getDocs(collection(db, "students"));

      for (const studentSnap of studentsSnap.docs) {
        const attendanceRef = doc(
          db,
          "sessions",
          sessionId,
          "attendance",
          studentSnap.id // ‚úÖ Firestore student DOC ID
        );

        const attendanceSnap = await getDoc(attendanceRef);

        // ‚úÖ CREATE ONLY IF NOT EXISTS
        if (!attendanceSnap.exists()) {
          await setDoc(attendanceRef, {
            studentId: studentSnap.data().studentId || "", // matric ID
            name: studentSnap.data().fullName || studentSnap.data().name || "",
            status: "Absent",
            method: "system"
          });
        }
      }
    }

    /* ================= LOAD STUDENTS ================= */
    async function loadStudentsForSession(sessionId) {
      studentTable.innerHTML = "";

      // 1Ô∏è‚É£ Get ALL students
      const studentsSnap = await getDocs(collection(db, "students"));

      // 2Ô∏è‚É£ Get attendance for this session
      const attendanceSnap = await getDocs(
        collection(db, "sessions", sessionId, "attendance")
      );

      // 3Ô∏è‚É£ Build attendance map (studentId ‚Üí attendance)
      const attendanceMap = {};
      attendanceSnap.forEach(docSnap => {
        attendanceMap[docSnap.id] = docSnap.data(); // doc.id === studentId
      });

      // 4Ô∏è‚É£ Render students ONLY
      studentsSnap.forEach(studentSnap => {
        const studentId = studentSnap.id;
        const student = studentSnap.data();

        const attendance = attendanceMap[studentId] || {};
        const status = attendance.status || "Absent";

        const statusClass =
          status === "Present"
            ? "status-present"
            : status === "Pending"
            ? "status-pending"
            : "status-absent";

        const verifyDisabled = status === "Present" ? "disabled" : "";

        const photo =
          student.photoUrl ||
          `https://ui-avatars.com/api/?name=${encodeURIComponent(student.name || studentId)}`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="Photo" class="photo-cell">
            <img src="${photo}" class="avatar" alt="Student photo">
          </td>

          <td data-label="Name">
            ${student.name || attendance.name || "-"}
          </td>

          <td data-label="ID">
            ${student.studentId || "-"}
          </td>

          <td data-label="Status">
            <span class="status-pill ${statusClass}">
              ${status}
            </span>
          </td>

          <td class="actions-cell" data-label="Actions">
            <button
              class="btn-view"
              data-name="${student.name || attendance.name || ''}"
              data-studentid="${student.studentId || ''}"
              data-email="${student.email || ''}"
              data-status="${status}"
              data-photo="${photo}"
            >
              View
            </button>

            <button
              class="btn-verify"
              data-studentid="${studentId}"
              ${verifyDisabled}
            >
              ${status === "Present" ? "Verified" : "Face Verify"}
            </button>
          </td>
        `;

        studentTable.appendChild(tr);
      });
    }


    // ===== Reset Current Session =====  //
    async function resetCurrentSession() {
      const sessionId = sessionSelect.value;

      if (!sessionId) {
        alert("Please select a session first.");
        return;
      }

      try {
        const attendanceRef = collection(
          db,
          "sessions",
          sessionId,
          "attendance"
        );

        const snap = await getDocs(attendanceRef);

        const updates = snap.docs.map(docSnap =>
          updateDoc(docSnap.ref, {
            status: "Absent"
          })
        );

        await Promise.all(updates);

        await loadStudentsForSession(sessionId);

        alert("Session has been reset. All students are now Absent.");
      } catch (err) {
        console.error("Reset session failed:", err);
        alert("Failed to reset session. See console.");
      }
    }

    // START QR SCANNER BUTTON (redirect only)
    startScannerBtn.addEventListener("click", () => {
      const sessionId = sessionSelect.value;

      if (!sessionId) {
        alert("Please select a session first");
        return;
      }

      window.location.href = `qrscanner.html?session=${encodeURIComponent(sessionId)}`;
    });

    /* ================= SESSION CHANGE ================= */
    sessionSelect.addEventListener("change", async () => {
      const sessionId = sessionSelect.value;
      if (!sessionId) return;

      localStorage.setItem("selectedSession", sessionId);

      await ensureSessionAttendance(sessionId);
      await loadStudentsForSession(sessionId);
    });


    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      location.href = "index.html";
    });

    // üîÑ Reload attendance when returning from face recognition
    window.addEventListener("load", async () => {
      const selectedSession = sessionSelect.value;
      if (selectedSession) {
        console.log("Reloading attendance for session:", selectedSession);
        await loadStudentsForSession(selectedSession);
      }
    });

    // ===== View Student Modal Logic =====
    const viewModal = document.getElementById("viewStudentModal");
    const closeViewModal = document.getElementById("closeViewModal");

    document.addEventListener("click", e => {
      const btn = e.target.closest(".btn-view");
      if (!btn) return;

      document.getElementById("modalStudentName").textContent =
        btn.dataset.name || "-";

      document.getElementById("modalStudentId").textContent =
        btn.dataset.studentid || "-";

      document.getElementById("modalStudentEmail").textContent =
        btn.dataset.email || "-";

      document.getElementById("modalStudentStatus").textContent =
        btn.dataset.status || "-";

      document.getElementById("modalStudentPhoto").src =
        btn.dataset.photo || "assets/default-avatar.png";

      viewModal.classList.remove("hidden");
    });


    closeViewModal.addEventListener("click", () => {
      viewModal.classList.add("hidden");
    });

    viewModal.addEventListener("click", e => {
      if (e.target === viewModal) {
        viewModal.classList.add("hidden");
      }
    });

    // ===== Face Verify button handler =====
    document.addEventListener("click", e => {
      const btn = e.target.closest(".btn-verify");
      if (!btn) return;

      const studentId = btn.dataset.studentid;
      const sessionId = document.getElementById("sessionSelect").value;

      if (!studentId || !sessionId) {
        Swal.fire(
          "Missing Data",
          "Please select a session before verifying attendance.",
          "warning"
        );
        return;
      }

      window.location.href =
        `face-recognition.html?studentId=${encodeURIComponent(studentId)}&session=${encodeURIComponent(sessionId)}`;
    });


    // ===== Create New Session =====
    async function createNewSession(sessionName) {
    try {
      const sessionRef = collection(db, "sessions");

      await addDoc(sessionRef, {
        name: sessionName,
        createdAt: serverTimestamp(),
        status: "ACTIVE",
        date: new Date().toISOString().slice(0, 10), // YYYY-MM-DD
        subjectId: sessionName.split("-")[0]         // INB33103
      });

      alert(`Session "${sessionName}" created`);
      await loadSessions();               // reload dropdown cleanly
      sessionSelect.value = "";           // reset selection
      localStorage.removeItem("activeSessionId"); // prevent restore duplication
    } catch (err) {
      console.error("Failed to create session:", err);
      alert("Failed to create session");
    }
  }

    // ===== Helper: Load image as Base64 =====
    async function loadImageAsBase64(url) {
    const res = await fetch(url);
    const blob = await res.blob();

    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }

    // ===== Export Current Session =====
    document.getElementById("exportCurrentBtn")
  .addEventListener("click", async () => {

    const sessionSelect = document.getElementById("sessionSelect");
    const sessionId = sessionSelect.value;
    const sessionName =
      sessionSelect.options[sessionSelect.selectedIndex]?.text;

    if (!sessionId || sessionSelect.selectedIndex === 0) {
      Swal.fire("No Session", "Please select a session first", "warning");
      return;
    }

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");

    const logoBase64 = await loadImageAsBase64("/assets/unikl-emblem.png");
    
    // ===== HEADER =====
    pdf.setLineWidth(0.6);
    pdf.line(20, 40, 190, 40);
    pdf.addImage(logoBase64, "PNG", 20, 14, 22, 22);
    pdf.setFontSize(16);
    pdf.text("QR Attendance System", 105, 20, { align: "center" });
    pdf.setFontSize(11);
    pdf.text("Universiti Kuala Lumpur", 105, 28, { align: "center" });
    

    // ===== SESSION INFO =====
    pdf.setFontSize(12);
    pdf.text(`Session: ${sessionName}`, 20, 50);
    pdf.text(`Date: ${new Date().toLocaleDateString()}`, 20, 58);

    // ===== TABLE HEADER =====
    let startY = 75;
    pdf.setFontSize(11);
    pdf.text("No", 20, startY);
    pdf.text("Name", 35, startY);
    pdf.text("Student ID", 95, startY);
    pdf.text("Status", 150, startY);
    pdf.line(20, startY + 2, 190, startY + 2);

    // ===== LOAD ATTENDANCE =====
    const attendanceRef = collection(
      db,
      "sessions",
      sessionId,
      "attendance"
    );

    const snap = await getDocs(attendanceRef);

    let rowY = startY + 10;
    let index = 1;

    for (const docSnap of snap.docs) {
      const studentId = docSnap.id;
      const att = docSnap.data();

      const studentSnap = await getDoc(
        doc(db, "students", studentId)
      );

      if (!studentSnap.exists()) continue;

      const student = studentSnap.data();

      pdf.text(String(index), 20, rowY);
      pdf.text(student.fullName || "-", 35, rowY);
      pdf.text(student.studentId || "-", 95, rowY);
      pdf.text(att.status || "-", 150, rowY);

      rowY += 8;
      index++;

      if (rowY > 270) {
        pdf.addPage();
        rowY = 30;
      }
    }

    pdf.save(`Attendance_${sessionName}.pdf`);
  });

    // ===== Admin UI button bindings =====
    document.addEventListener("DOMContentLoaded", () => {

      const createSessionBtn = document.getElementById("createSessionBtn");

    createSessionBtn.addEventListener("click", async () => {
      const sessionInput = document.getElementById("sessionNameInput");

      if (!sessionInput) {
        console.error("sessionNameInput not found in DOM");
        return;
      }

      const sessionName = sessionInput.value.trim();
      console.log("Session input value:", sessionName);

      if (!sessionName) {
        alert("Please enter a session name");
        return;
      }

      await createNewSession(sessionName);
      sessionInput.value = "";
    });
   
    // ===== Reset Current Session =====
    document.getElementById("resetSessionBtn").addEventListener("click", async () => {
      const confirmed = confirm(
        "This will reset ALL students to Absent for the selected session.\n\nProceed?"
      );

      if (!confirmed) return;

      await resetCurrentSession();
    });

  // Manage Students
  const manageStudentsBtn = document.getElementById("manageStudentsBtn");
  if (manageStudentsBtn) {
    manageStudentsBtn.addEventListener("click", () => {
      window.location.href = "admin-students.html";
    });
  }

});

 </script>
</body>
</html>
</head>
</html>
