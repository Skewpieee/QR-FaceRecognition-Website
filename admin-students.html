<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin â€” Student Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root{
    --blue:#1e2f7a;
    --blue-dark:#162566;
    --orange:#f58220;
    --bg:#f3f4f6;
    --card:#ffffff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --success-bg:#dcfce7;
    --success:#166534;
    --danger-bg:#fee2e2;
    --danger:#991b1b;
  }

  /* RESET */
  *{box-sizing:border-box}

  body{
    min-height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    margin:0;
    font-family:Inter,system-ui,sans-serif;
    background: #f4f6f8;
    color:var(--text);
  }

  /* ===== UniKL Top Stripe Header (MATCH index.html) ===== */
  .top-stripe{
    height:56px;
    display:flex;
    align-items:center;
    background:white;
    box-shadow:0 2px 6px rgba(3,6,12,0.06);
    position:sticky;
    top:0;
    z-index:50;
  }

  .stripe-orange{
    flex:0 0 8%;
    background:var(--orange);
    height:100%;
  }

  .stripe-blue{
    flex:0 0 18%;
    background:var(--blue-dark);
    height:100%;
  }

  .stripe-white{
    flex:1;
    height:100%;
    background:white;
    display:flex;
    align-items:center;
    padding-left:18px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:12px;
    font-weight:600;
    color:#213247;
  }

  .brand img{
    height:38px;
  }

  /* Mobile */
  @media(max-width:980px){
    .brand{ display:none; }
    .top-stripe{ height:42px; }
    .stripe-white{ padding-left:0; }
  }


.header-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 14px 24px;
  display: flex;
  align-items: center;
}

.logo {
  height: 42px;
}

.title{
  font-weight:700;
}

.subtitle{
  font-size:13px;
  color:#6b7280;
}

  /* GRID */
  .grid {
  display: grid;
  grid-template-columns: 1fr 1.4fr; 
  gap: 40px;
  align-items: start; 
}

  /* SECTION */
  .section {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,.05); /* softer */
}

  /* FORM */
  input,button{
    width:100%;
    padding:12px;
    margin-bottom:12px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:14px;
  }

  button{
    background:var(--blue);
    color:#fff;
    font-weight:600;
    cursor:pointer;
  }

  button:disabled{
    background:#9ca3af;
  }

  /* TABLE */
  .table-wrap{
    width: 100%;
    border-radius:14px;
    overflow:hidden;
    border:1px solid var(--border);
  }

  table{
    font-size: 15px;
    width:100%;
    border-collapse:collapse;
  }

  thead{
    background:linear-gradient(180deg,var(--blue),var(--blue-dark));
    color:#fff;
  }

  th{
    padding:16px 20px;
    text-align:left;
  }

  td{
    padding:18px 20px;
    vertical-align:middle;
  }

  tbody tr{
    background:#fff;
    border-bottom:1px solid var(--border);
  }

  tbody tr:hover{
    background:#f9fafb;
  }

  /* PHOTO */
  .student-photo {
  width: 72px;
  height: 72px;
  border-radius: 12px;
  object-fit: cover;
  background: #eef2f7;
  border: 2px solid #e5e7eb;
}

  .photo-placeholder{
    width:48px;
    height:48px;
    border-radius:10px;
    background:#e5e7eb;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
  }

  /* STATUS */
  .status{
    display:inline-block;
    padding:6px 14px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
  }

  .status.present{
    background:var(--success-bg);
    color:var(--success);
  }

  .status.absent{
    background:var(--danger-bg);
    color:var(--danger);
  }

  .content {
  max-width: 1300px;     
  margin: 40px auto;
  padding: 0 20px;
}

.page-subtitle{
  color:#6b7280;
  margin-bottom:24px;
}

.registered-section {
  position: relative;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
}

h3 {
  font-size: 18px;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 28px;
}

/* Logout button â€“ same behavior as admin.html */
.btn-logout {
  background: #cf3341;
  color: #ffffff;
  border: none;
  padding: 6px 14px;          
  border-radius: 999px;      /* pill shape */
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  white-space: nowrap;

  /* ðŸ”¥ critical fixes */
  width: auto;
  max-width: fit-content;
  align-self: center;
}

.btn-logout:hover {
  background: #b92c38;
}

.page-wrap {
  padding: 40px 20px 80px;
}

.dashboard-card {
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  background: #ffffff;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(0,0,0,.12);
  padding: 28px;
}

/* ===============================
   ðŸ“± MOBILE RESPONSIVE FIXES
   =============================== */

@media (max-width: 768px) {

  /* Stack form & table vertically */
  .grid {
    grid-template-columns: 1fr;
    gap: 24px;
  }

  /* Reduce outer spacing */
  .content {
    margin: 20px auto;
    padding: 0 12px;
  }

  .page-wrap {
    padding: 20px 0 60px;
  }

  .dashboard-card {
    padding: 18px;
  }

  /* Header alignment */
  .dashboard-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .btn-logout {
    align-self: flex-end;
  }

  /* Make table scrollable instead of breaking layout */
  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  table {
    min-width: 600px;
  }

  /* Smaller photos on mobile */
  .student-photo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
  }

  /* Tighten table spacing */
  th, td {
    padding: 12px 14px;
    font-size: 13px;
  }

  /* Form inputs */
  input, button {
    font-size: 16px; /* prevents mobile zoom */
  }
}

@media (max-width: 768px) {
  .dashboard-card {
    margin-left: auto;
    margin-right: auto;
  }

  .dashboard-header {
    width: 100%;
  }

  /* ---------- Header polish ---------- */
  .dashboard-header h1 {
    font-size: 20px;
  }

  .dashboard-header p {
    font-size: 13px;
    line-height: 1.4;
    max-width: 90%;
  }

  /* Keep logout visually attached to header */
  .btn-logout {
    margin-top: 6px;
  }

  /* ---------- Table usability ---------- */
  .table-wrap {
    border-radius: 12px;
    overflow-x: auto;
  }

  table {
    min-width: 680px; /* forces horizontal scroll */
  }

  th {
    font-size: 13px;
    white-space: nowrap;
  }

  td {
    font-size: 13px;
    white-space: nowrap;
  }

  /* Status badge smaller */
  .status {
    font-size: 11px;
    padding: 4px 10px;
  }
}

</style>
</head>
<body>

  <!-- UniKL Top Header -->
  <div class="top-stripe">
    <div class="stripe-orange"></div>
    <div class="stripe-blue"></div>
    <div class="stripe-white">
      <div class="brand">
        <img src="./assets/unikl-wordmark.webp" alt="UniKL">
        QR Attendance System â€” Universiti Kuala Lumpur
      </div>
    </div>
  </div>

<div class="content">

<!-- PAGE TITLE -->  
  <div class="page-wrap">

  <div class="dashboard-card">

    <div class="dashboard-header">
  <div>
    <h1>Admin Dashboard</h1>
    <p>QR-Based Student Attendance â€” Student management</p>
  </div>

  <button id="logoutBtn" class="btn-logout">Logout</button>
</div>

  <div class="grid">

  <!-- CREATE STUDENT -->
  <div class="section create-student">
    <h3>Create Student</h3>

    <input id="fullName" placeholder="Full Name" />
    <input id="studentId" placeholder="Student ID" />
    <input id="email" placeholder="Email" />
    <input type="file" id="passportPhoto" accept="image/*" />

    <small>Upload student passport photo (admin only)</small>
    <button id="createStudentBtn">Create Student</button>
    <small>Temporary password will be emailed to admin.</small>
  </div>

  <!-- REGISTERED STUDENTS -->
  <div class="section registered-section">
    <h3>Registered Students</h3>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Photo</th>
            <th>Name</th>
            <th>ID</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ðŸ”¥ FIREBASE LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    collection,
    onSnapshot,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  /* ================= FIREBASE ================= */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const btn = document.getElementById("createStudentBtn");
  const tableBody = document.getElementById("studentsTableBody");

  let currentUser = null;

  // ðŸ” AUTH CHECK
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Not authenticated");
      window.location.href = "index.html";
      return;
    }

    currentUser = user;
    loadStudents();
  });

  // ðŸ“¥ LOAD STUDENTS (ADMIN LIST)
  function loadStudents() {
    const q = query(
      collection(db, "students"),
      orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
      tableBody.innerHTML = "";

      if (snapshot.empty) {
        tableBody.innerHTML =
          `<tr><td colspan="4">No students registered</td></tr>`;
        return;
      }

      snapshot.forEach((doc) => {
        const s = doc.data();

        const row = document.createElement("tr");
        const photoHtml = s.photoUrl
        ? `<img src="${s.photoUrl}" class="student-photo" />`
        : `<div class="photo-placeholder">N/A</div>`;
        row.innerHTML = `
        <td>${photoHtml}</td>
        <td>${s.fullName || "-"}</td>
        <td>${s.studentId || doc.id}</td>
        <td>
          <span class="status ${s.status === 'ABSENT' ? 'absent' : 'present'}">
            ${s.status || 'ACTIVE'}
          </span>
        </td>
      `;
        tableBody.appendChild(row);
      });
    }, (err) => {
      console.error("LOAD STUDENTS ERROR:", err);
    });
  }

  // ðŸŽ¯ CREATE STUDENT
  btn.onclick = async () => {
    if (!currentUser) {
      alert("Admin not authenticated yet");
      return;
    }

    const studentId = document.getElementById("studentId").value.trim();
    const fullName = document.getElementById("fullName").value.trim();
    const email = document.getElementById("email").value.trim();
    const file = document.getElementById("passportPhoto").files[0];

    if (!studentId || !fullName || !email) {
      alert("Please fill in all fields");
      return;
    }

    btn.disabled = true;
    btn.textContent = "Creating...";

    try {
      const token = await currentUser.getIdToken(true);

      // 1ï¸âƒ£ CREATE AUTH USER
      const res = await fetch(
        "https://us-central1-qr-based-587af.cloudfunctions.net/adminCreateUser",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            studentId,
            displayName: fullName,
            email
          })
        }
      );

      if (!res.ok) {
        throw new Error(await res.text());
      }

      const data = await res.json();
      const studentUid = data.uid;

      // ðŸ“¸ UPLOAD PASSPORT PHOTO (ADMIN ONLY)
if (file) {
  const studentUid = data.uid;

  const photoRef = ref(
    storage,
    `student-photos/${studentUid}.jpg`
  );

  const metadata = {
    contentType: file.type || "image/jpeg"
  };

  console.log("UPLOAD PATH:", photoRef.fullPath);
  console.log("ADMIN UID:", currentUser.uid);
  console.log("FILE TYPE:", metadata.contentType);

  await uploadBytes(photoRef, file, metadata);

  const photoUrl = await getDownloadURL(photoRef);

  await fetch(
    "https://us-central1-qr-based-587af.cloudfunctions.net/updateStudentPhoto",
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        uid: studentUid,
        photoUrl
      })
    }
  );
}


      alert(
        "Student created successfully!\n\nTemporary password:\n" +
        data.tempPassword
      );

      document.getElementById("studentId").value = "";
      document.getElementById("fullName").value = "";
      document.getElementById("email").value = "";
      document.getElementById("passportPhoto").value = "";

    } catch (err) {
      console.error("CREATE STUDENT ERROR:", err);
      alert(err.message || "Failed to create student");
    }

    btn.disabled = false;
    btn.textContent = "Create Student";
  };

  // ðŸšª LOGOUT
  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    window.location.href = "index.html";
  };
</script>
</body>
</html>
